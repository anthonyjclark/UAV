---
title: "NO2_Sensors"
author: "Anna Madison Burns"
date: "6/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Our Sensor

We are using a MiCS-2714 from SGX Sensortech, which costs 8.75 USD.  In addition to the sensor, we also purchased the accompanying MiCS Quickstart Evaluation Board from SGX Sensortech for 38.75 USD.  Furthermore, we have the corresponding HTU21D humidity and temperature sensor, which was purchaed from SGX Sensortech for 2.60 USD.  

Because our sensor produces analog data, but our Pi reads digital data, we need an analog to digital convertor.  We are using the MCP3008 Raspberry Pi Interface, which costs 5.99 USD from Amazon. 

# Materials Needed

* 1 MiCS-2714 NO2 sensor
* 1 MiCS Quickstart Evaluation Board
* 1 jumper
* 1 breadboard
* 1 MCP3008 ADC convertor
* 4 M-M extension jumper wires
* 7 M-F extension jumper wires
* 2 F-F extension jumper wires

# Wiring the Analog to Digital Convertor

To set up our Adafruit MCP3008 ADC, we will use the Adafruit Github packages.  More information on this process is available at https://learn.adafruit.com/raspberry-pi-analog-to-digital-converters/mcp3008.  

Make sure the Raspberry Pi is not connected to power as you complete these steps.

1.  Remove the MCP3008 from the packaging, and find the half-circle that is printed on the back of the convertor.  Place the convertor with the pins facing down in rows E and F (going across the gap in the middle of the breadboard) between rows 24 and 31, with the half-circle on row 31.  The direction of the convertor is very important, because each of the pins has a specific purpose.

2.  Place two M-M jumper wires in the breadboard, with one connecting 31d to 31- (the vertical row directly next to row a), and the other connecting 30d to 30-.  

3.  Connect the M end of a M-F jumper wire to 35-, and connect the F end to pin 1 (3.3V) on the Raspberry Pi.  Your convertor is now connected to power!

4.  Place two more M-M jumper wires in the breadboard, with one connecting 29d to 29+ (the vertical row on the edge of the board on the a-side), and the other connecting 24d to 24+. 

5.  Connect the M end of a M-F jumper wire to 36+, and connect the F end to pin 9 (GND) on the Raspberry Pi.  Your convertor is now grounded!

6.  Connect the M end of a M-F jumper wire to 28d on the breadboard; connect the F end to pin 23 (GPIO11/SPI-SCLK) on the Raspberry Pi.

7.  Connect the M end of a M-F jumper wire to 27d on the breadboard; connect the F end to pin 21 (GPIO9/SPI-MISO) on the Raspberry Pi.

8.  Connect the M end of a M-F jumper wire to 26d on the breadboard; connect the F end to pin 19 (GPIO10/SPI-MOSI) on the Raspberry Pi.

9.  Connect the M end of a M-F jumper wire to d on the breadboard; connect the F end to pin 24 (GPIO8/SPI-CEO)  on the Raspberry Pi.

10.  Your MCP3008 is now fully connected to your Pi, and you can connect your Pi to a powersource.

## Testing the Digital Connection of the MCP3008

We'll go through this process to download the proper libraries, and to make sure that the MCP3008 is correctly wired.

1.  Open up the Pi terminal, either through a monitor or a remote access connection (for more information on these options, visit the Raspberry Pi Guide).

2.  Download the necessary packages for using the MCP3008 from the Adafruit library with the following commands:

```{python, eval=FALSE, python.reticulate=FALSE}
sudo apt-get update # Make sure your Pi is up-to-date... this can take some time
sudo apt-get install build-essential python-dev python-smbus git # You may already have some of these packages, but re-download just in case
cd ~ # This takes you to the main directory
git clone https://github.com/adafruit/Adafruit_Python_MCP3008.git # This downloads the appropriate packages from Github, and is one of the advantages of using an Adafruit sensor
cd Adafruit_Python_MCP3008 # Changing the directory to the repository we just downloaded
sudo python setup.py install # Install the appropriate library
```

Now we can begin to test whether or not the convertor is properly connected.

3.  Change directories to the example folder within the Adafruit MCP3008 package with

```{python, eval=FALSE, python.reticulate=FALSE}
cd Adafruit_Python_MCP3008/examples
```

4.  Run the test file that the package already wrote for you with

```{python, eval=FALSE, python.reticulate=FALSE}
sudo python simpletest.py
```

The output will be eight columns (for each of the ADC channels on the sensor) with a value of how much power is being sent to each one.  For example, if each column has a value of 1023, then each is receiving the full 3.3 V.  This code will update every half second, so to stop is you need to type Ctrl C.  If the ADC channels are getting power, then you are good to go!

# Wiring the MICS Quick Start Board

The MiCS Quickstart Board has internal wiring for multiple MiCS sensors, and makes it much easier to begin working with our MiCS-2714.  The board should come with three jumpers, as well as the board.  Be careful, because the sensor itself is very, very small.

1.  Remove the sensor and quickstart board from the packagining.  Place the sensor into the case at the top right of the board; make sure that it is flush to the sides of the case, so that the metallic strips are connected on either side.

2.  Take one of the jumpers, and place it over the J3 and J4 pins.

3.  The MiCS-2714 sensor uses Vin+, GND, and VoutB:

* Using a F-F jumper wire, connect Vin+ to Raspberry Pi pin 4 (5V).

* Using a F-F jumper wire, connect GND to Raspberry Pi pin 6 (GND).

* Using a M-F jumper wire, connect VoutB to 31g (Channel 0) on the breadboard (this allows the analog data to be sent through the MCP3008 analog-digital convertor so that the Pi can read it).

Now all the assembly is done... all that is left is to code!

# Code for the Sensor




# Work Flow

## Physical Assembly

https://sgx.cdistore.com/datasheets/sgx/micsquickstartevaluationboard-cdi.pdf

Page 2 of this guide specifies that for the MCIS-2714, once the jumpers are on the output is via VOUTB and the power input is via V+.  Accordingly, I used two F-F jumpers to connect Vin+ to pin 2 (5V) and VOUTA to pin 7 (GPIO4).  Something I am worried about is that multiple sources have stated that the MICS Quick Start Evaluation Board takes between 7-24(?) volts of power and then reduces it to 5V for the sensor... with this in mind I connected the power source to 5V, but I'm not sure if it needs more in order to reduce it back.

GND connect to ground.

Next:  Look in book on how to program to receive signal from GPIO4, ping sensor to see if this set-up even works.

## Code

Some potential ideas:

### SPI input

Sensor connected to channel 0 on ADC

Typical NO2 detection range is .05 to 10 ppm

```{python, eval=FALSE, python.reticulate=FALSE}
import spidev
import time
import os
 
# Open SPI bus
spi = spidev.SpiDev()
spi.open(0,0)
spi.max_speed_hz=1000000
 
# Function to read SPI data from MCP3008 chip
# Channel must be an integer 0-7
def ReadChannel(channel):
  adc = spi.xfer2([1,(8+channel)<<4,0])
  data = ((adc[1]&3) << 8) + adc[2]
  return data
 
# Function to convert data to voltage level,
# rounded to specified number of decimal places.
def ConvertVolts(data,places):
  volts = (data * 3.3) / float(1023)
  volts = round(volts,places)
  return volts
 
# Function to calculate temperature from
# TMP36 data, rounded to specified
# number of decimal places.
def ConvertNO2(data,places):
 
  # ADC Value (their temp sensor)
  # (approx)  Temp  Volts
  #    0      -50    0.00
  #   78      -25    0.25
  #  155        0    0.50
  #  233       25    0.75
  #  310       50    1.00
  #  465      100    1.50
  #  775      200    2.50
  # 1023      280    3.30
  
  # ADC Value (MiCS-2714)
  # (approx)  NO2   Volts
  #    0       .05    0
  #   78      
  #  155
  #  233
  #  310
  #  465
  #  775
  # 1023      10     3.30
 
  NO2 = ((data * 10.05)/float(1023))+0.05
  NO2 = round(NO2,places)
  return NO2
 
# Define sensor channels
NO2_channel = 0
 
# Define delay between readings
delay = 10
 
while True:
 
  # Read the temperature sensor data
  NO2_level = ReadChannel(NO2_channel)
  NO2_volts = ConvertVolts(NO2_level,0)
  NO2       = ConvertTemp(NO2_level,0)
 
  # Print out results
  print "--------------------------------------------"
  print("Temp : {} ({}V) {} ppm".format(NO2_level,NO2_volts,NO2))
 
  # Wait before repeating loop
  time.sleep(delay)

```


### GPIO input

```{python, eval=FALSE, python.reticulate=FALSE}
import rpi.GPIO as GPIO
import time

try:
  GPIO.setmode(GPIO.BOARD)
  
```


### Editing PMS5003 code

```{python, eval=FALSE, python.reticulate=FALSE}
import serial
import time
import collections

class Sensor():
  def __init__(self, tty='/dev/ttys0'): # Need to change this, reads from GPIO not UART... trickles down
    self.tty = tty
    
  def open(self):
    self.serial = serial.Serial(self.tty, baudrate = 9600)
  
  def close(self):
    self.serial.close()

  # Need to figure out reading the sensor
  
def write_to_csv():
  if __name__ == '__main__':
    with open('/home/pi/mics2714_data.csv', mode = 'a') as csv_file:
      csv_writer = csv.writer(csv_file)
      csv_writer.writerow([data])
    with open('/home/pi/mics2714_data.csv', mode = 'w') as csv_file:
      csv_reader = csv.reader(csv_file)
      for row in csv_reader:
        print(row)
      
if __name__ == '__main__': 
  while True: 
    '''
    Test code
    '''
    sensor = Sensor() 
    sensor.open() 
    data = sensor.read() 
    sensor.close() 
    print(data)
    write_to_csv() 
    time.sleep(30)
  
```


# Helpful Resources for Setting Up Sensor

**Note: AB has not yet figured out how to set up this sensor; these are the sources that looked like they could be useful.**

https://www.instructables.com/id/Smart-Sensor/ - contains link to downlaod pdf on MiCS-2714 (**this was probably the most helpful source I found**) 

https://download.mikroe.com/documents/datasheets/MiCS-2714%20Datasheet.pdf - Datasheet for the sensor

https://sgx.cdistore.com/datasheets/sgx/load-resistance-for-mics-sensors-measurements.pdf - "How to set up load resistance for MiCS sensors measurements"

https://www.sgxsensortech.com/content/uploads/2014/08/AN2-%e2%80%93-Frequently-Asked-Questions-for-MiCS-Gas-Sensors.pdf - "Frequently asked questions for MiCS gas sensors"

https://www.sgxsensortech.com/content/uploads/2014/08/AN-0172-SGX-Metal-Oxide-Gas-Sensors-V1.pdf - "SGX metal oxide sensors (how to use them and how they perform)"

## Scientific Papers that Use a Similar Setup

http://ijiet.com/wp-content/uploads/2018/01/3.pdf - "IOT based indoor air pollution monitor using Raspberry Pi" (paper that uses this sensor with Raspberry Pi)

https://www.mdpi.com/1424-8220/10/6/5469/htm - "Metal oxide semi-conductor gas sensors in environmental monitoring"

https://iopscience.iop.org/article/10.1088/1757-899X/536/1/012050/pdf - "Monitoring system for organic fertilizer plant controller using solar energy" (paper that uses this sensor with Raspberry Pi)


